(function() {

var w = 760,
    h = 800,
    format = d3.format(',d'),
    fill = d3.scale.category20c(),
    lscale = d3.scale.sqrt().range([1, 1.7]),
    maxval;

var spiral = d3.layout.pack()
    .size([w, h])
    .padding(6.6);

var vis = d3.select('#vis').append('svg')
    .attr('width', w)
    .attr('height', h)
    .attr('class', 'spiral')
    .append('svg:g')
      .call(d3.behavior.zoom().on('zoom', rescale));

d3.json('/json/exploit-db-platforms.json', function(json) {
  var node = vis.selectAll('g.node')
      .data(spiral.nodes(nodes(json))
      .filter(function(d) { return !d.children; }))
    .enter().append('g')
      .attr('class', 'node')
      .attr('transform', function(d) { return 'translate(' + d.x + ',' + d.y + ')'; });

  node.append('title')
      .text(function(d) { return d.name + ': ' + format(d.value); });

  node.append('circle')
      .attr('r', function(d) { return d.r; })
      .style('fill', function(d) { return fill(d.value); })
      .call(events);

  node.append('text')
      .attr('text-anchor', 'middle')
      .attr('dy', '.3em')
      .attr('style', function(d) { return 'font-size:' + lscale(d.value); })
      .text(function(d) { return d.name; })
      .call(events);

});



function nodes(data) {
  return {children: data}
}

function bar(name, data) {
  maxval = d3.max(data, function(d) { return d.value });
  var barscale = d3.scale.linear()
    .domain([0, maxval])
    .range(['0px', '280px']);

  d3.select('#platform').text(name);

console.log(maxval, barscale(maxval))

  var bar = d3.select('#exptypes');
  bar.selectAll('svg').remove();
  var svg = bar.append('svg')
    .attr('class', 'bar')
    .attr('width', 280)
    .attr('height', 20 * data.length);

  svg.selectAll('rect')
    .data(data)
    .enter().append('rect')
    .attr('y', function(d, i) { return i * 20; })
    .attr('width', function(d) { return barscale(d.value)})
    .attr('height', 18)
}

function nodecolor(elt, color) {
    if ('text' == elt.nodeName)
        d3.select(elt.previousSibling).style('fill', color)
    else
        d3.select(elt).style('fill', color)
}

function events(d) {
  d.on('click', function(d) {
    bar(d.name, d.types)
  });
  d.on('mouseover', function(d) { nodecolor(this, '#ddd') });
  d.on('mouseout', function(d) { nodecolor(this, fill(d.value)) });
}

function rescale() {
  vis.attr('transform', 'translate(' + d3.event.translate + ')'
      + ' scale(' + d3.event.scale + ')')
}

})();
